<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>用go实现sse | myth的小屋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="为什么要使用SSE:对于现在的互联网应用, 实时的消息推送是很常见的一种形式, (用户已经完全不能忍受一点点的延迟了) 但是大部分的场景, 其实我们基本都是用ajax 请求, 长轮训来实现, 或者也有同学使用websocket 等等技术,来实现 ajax请求这个是最常见的实现, 不断的初始化, 前端请求, 大概根据固定的时间不断的去请求, 看看是否数据准备成功 长轮训:下图是一个长轮训的示例  大">
<meta property="og:type" content="article">
<meta property="og:title" content="用go实现sse">
<meta property="og:url" content="https://kevinmythcheng.github.io/2022/07/10/%E7%94%A8go%E5%AE%9E%E7%8E%B0sse/index.html">
<meta property="og:site_name" content="myth的小屋">
<meta property="og:description" content="为什么要使用SSE:对于现在的互联网应用, 实时的消息推送是很常见的一种形式, (用户已经完全不能忍受一点点的延迟了) 但是大部分的场景, 其实我们基本都是用ajax 请求, 长轮训来实现, 或者也有同学使用websocket 等等技术,来实现 ajax请求这个是最常见的实现, 不断的初始化, 前端请求, 大概根据固定的时间不断的去请求, 看看是否数据准备成功 长轮训:下图是一个长轮训的示例  大">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/1*m-FBYS8LqUwnUzniHzO8Xg.png">
<meta property="og:image" content="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/1*0w3tMXm7jr174bqOprcdOg.png">
<meta property="og:image" content="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/1*RWFAf6L6LYgd9kJaUxgmpQ.png">
<meta property="og:image" content="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/image-20220807174750805.png">
<meta property="og:image" content="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/image-20220807174926605.png">
<meta property="og:image" content="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/image-20220807175146082.png">
<meta property="og:image" content="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/image-20220807175325258.png">
<meta property="og:image" content="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/image-20220807175253932.png">
<meta property="article:published_time" content="2022-07-10T13:33:52.000Z">
<meta property="article:modified_time" content="2022-08-13T06:41:04.230Z">
<meta property="article:author" content="Kevin Chenge">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/1*m-FBYS8LqUwnUzniHzO8Xg.png">
  
    <link rel="alternate" href="/atom.xml" title="myth的小屋" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">myth的小屋</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://kevinMythCheng.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-用go实现sse" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/10/%E7%94%A8go%E5%AE%9E%E7%8E%B0sse/" class="article-date">
  <time datetime="2022-07-10T13:33:52.000Z" itemprop="datePublished">2022-07-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/go%E7%9A%84%E5%B0%8F%E5%A4%A9%E5%9C%B0/">go的小天地</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      用go实现sse
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="为什么要使用SSE"><a href="#为什么要使用SSE" class="headerlink" title="为什么要使用SSE:"></a>为什么要使用SSE:</h2><p>对于现在的互联网应用, 实时的消息推送是很常见的一种形式, (用户已经完全不能忍受一点点的延迟了)</p>
<p>但是大部分的场景, 其实我们基本都是用ajax 请求, 长轮训来实现, 或者也有同学使用websocket 等等技术,来实现</p>
<h3 id="ajax请求"><a href="#ajax请求" class="headerlink" title="ajax请求"></a>ajax请求</h3><p>这个是最常见的实现, 不断的初始化, 前端请求, 大概根据固定的时间不断的去请求, 看看是否数据准备成功</p>
<h3 id="长轮训"><a href="#长轮训" class="headerlink" title="长轮训:"></a>长轮训:</h3><p>下图是一个长轮训的示例</p>
<p><img src="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/1*m-FBYS8LqUwnUzniHzO8Xg.png" alt="img"></p>
<p>大概的流程 如下, </p>
<ol>
<li>客户端初始化了一个请求, 请求服务端</li>
<li>服务端在数据没有准备好的情况下 不会回复服务端,这个时候 请求会先挂起</li>
<li>当数据完全准备好了, 服务端回复客户端</li>
<li>这个时候 客户端 会在发起一个新的请求, 来完成这次会话</li>
</ol>
<h3 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h3><p>他是一个基于TCP 的全双工协议, 基于socket 进行客户端和服务端的通信.</p>
<p><img src="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/1*0w3tMXm7jr174bqOprcdOg.png" alt="img"></p>
<p>Websocket 的流转大概如上图所示,</p>
<ol>
<li>客户端先向服务端发起了一个握手请求, 其中请求协议包括Upgrade 标头以切换到 WebSocket 协议以及其他信息.</li>
<li>这个时候服务端接收到, 并且返回接收成功</li>
<li>这个时候,通道就已经建立成功, 我们就可以进行通信了</li>
<li>当一方进行通道的关闭, 这个服务之间的通信 就会进行关闭</li>
</ol>
<h2 id="SSE-Server-sent-events"><a href="#SSE-Server-sent-events" class="headerlink" title="SSE(Server sent events)"></a>SSE(Server sent events)</h2><p>从名字上就能看出来, 这个是只能服务端向客户端推送消息.</p>
<p>也就是说他是个单工的一个请求</p>
<p><img src="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/1*RWFAf6L6LYgd9kJaUxgmpQ.png" alt="img"></p>
<p>大概的流程如下</p>
<ol>
<li>客户端用EventSource API 初始化一个stream 流,通常要指定特定的Url</li>
<li>服务端可以接收正常的request , 并且进行处理,会将连接一直开启, 服务端也可以主动的进行关闭</li>
<li>客户端可以接收到服务端给定过来的数据, 如果收到服务端过来的关闭请求, 也会进行关闭. 当然客户端也可以主动关闭请求.</li>
</ol>
<table>
<thead>
<tr>
<th>对比</th>
<th>轮训</th>
<th>长轮训</th>
<th>sse</th>
<th>websocket</th>
</tr>
</thead>
<tbody><tr>
<td>使用协议</td>
<td>HTTP 协议</td>
<td>HTTP 协议</td>
<td>HTTP</td>
<td>TCP 的全双工协议</td>
</tr>
<tr>
<td>服务器压力,资源耗费</td>
<td>压力非常大</td>
<td>压力比较大</td>
<td>比较小</td>
<td>比较小</td>
</tr>
<tr>
<td>请求顺序问题</td>
<td>无</td>
<td>如果连接请求过大, 顺序有可能不一致</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td>丢消息问题</td>
<td>无</td>
<td>如果客户端,关闭 消息有可能丢失</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td>复杂度</td>
<td>实现非常简单</td>
<td>前端目前Ajax 就可以支持</td>
<td>相对来说, 比较轻量</td>
<td>需要服务端实现一个websocket服务器. 比较复杂</td>
</tr>
<tr>
<td>支持的浏览器</td>
<td>都支持</td>
<td>都支持</td>
<td>目前IE 和低版本的Edge 不支持</td>
<td>需要支持html5 的浏览器</td>
</tr>
</tbody></table>
<h2 id="什么是sse"><a href="#什么是sse" class="headerlink" title="什么是sse?"></a>什么是sse?</h2><blockquote>
<p><strong>Server-Sent Events</strong> (<strong>SSE</strong>) is a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Server_push">server push</a> technology enabling a client to receive automatic updates from a server via an HTTP connection, and describes how servers can initiate data transmission towards clients once an initial client connection has been established. They are commonly used to send message updates or continuous data streams to a browser client and designed to enhance native, cross-browser streaming through a JavaScript API called EventSource, through which a client requests a particular URL in order to receive an event stream. The EventSource API is standardized as part of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/HTML5">HTML5</a>[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Server-sent_events#cite_note-1">1]</a> by the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/World_Wide_Web_Consortium">WHATWG</a>. The <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Media_type">mime type</a> for SSE is <code>text/event-stream</code>.                                                                                    - WIKIPEDIA</p>
<p>翻译过来 大概几个重点,</p>
<ol>
<li>服务端的数据变动通过HTTP自动推送到客户端</li>
<li>客户端需要跟服务端进行一次连接,之后就会保持长连接</li>
<li>通过JavaScripts 的API<strong>EventSource</strong>, 经过一个特定的URL进行传输</li>
<li>是一个标准的HTML5 协议,  text/event-stream</li>
</ol>
</blockquote>
<h3 id="Golang-实现SSE"><a href="#Golang-实现SSE" class="headerlink" title="Golang 实现SSE"></a>Golang 实现SSE</h3><h4 id="go-sse"><a href="#go-sse" class="headerlink" title="go-sse :"></a>go-sse :</h4><p>简单的客户端 :</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>SSE Examples<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">strong</span>&gt;</span>Messages<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">        e1 = <span class="keyword">new</span> EventSource(<span class="string">&#x27;/events/channel-1&#x27;</span>);</span></span><br><span class="line"><span class="javascript">        e1.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&#x27;messages&#x27;</span>).innerHTML += <span class="string">&#x27;Message on channel-1: &#x27;</span> + event.data + <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="javascript">        e2 = <span class="keyword">new</span> EventSource(<span class="string">&#x27;/events/channel-2&#x27;</span>);</span></span><br><span class="line"><span class="javascript">        e2.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&#x27;messages&#x27;</span>).innerHTML += <span class="string">&#x27;Message on channel-2: &#x27;</span> + event.data + <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span></span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>用EventSource API 设定了固定的Url</p>
<p>服务端代码:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">app := iris.New()</span><br><span class="line">	app.Get(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(ctx iris.Context)</span></span> &#123;</span><br><span class="line">		ctx.ServeFile(<span class="string">&quot;../static/index.html&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	app.Get(<span class="string">&quot;/events/&#123;channel&#125;&quot;</span>, iris.FromStd(s))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			s.SendMessage(<span class="string">&quot;/events/channel-1&quot;</span>, sse.SimpleMessage(time.Now().Format(<span class="string">&quot;2006/02/01/ 15:04:05&quot;</span>)))</span><br><span class="line">			time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		i := <span class="number">0</span></span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			i++</span><br><span class="line">			s.SendMessage(<span class="string">&quot;/events/channel-2&quot;</span>, sse.SimpleMessage(strconv.Itoa(i)))</span><br><span class="line">			time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	app.Listen(<span class="string">&quot;:3000&quot;</span>)</span><br></pre></td></tr></table></figure>



<p>第一步: 开启服务端</p>
<p>先开启服务端: 这个时候, 客户端没有加入, 即使发消息也是接收不到的, </p>
<p><img src="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/image-20220807174750805.png" alt="image-20220807174750805"></p>
<p>第二步: 开启客户端 localhost:3000</p>
<p>一旦客户端链接, 效果如下:</p>
<p><img src="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/image-20220807174926605.png" alt="image-20220807174926605"></p>
<p>服务端的显示如下:</p>
<p><img src="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/image-20220807175146082.png" alt="image-20220807175146082"></p>
<p>开启其他客户端, 也能收到最新的消息</p>
<p>服务端展示如下:</p>
<p><img src="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/image-20220807175325258.png" alt="image-20220807175325258"></p>
<p>客户端展示如下:</p>
<p><img src="https://typora-1303153435.cos.ap-chengdu.myqcloud.com/img/image-20220807175253932.png" alt="image-20220807175253932"></p>
<p>链接:</p>
<p><a target="_blank" rel="noopener" href="https://medium.com/system-design-blog/long-polling-vs-websockets-vs-server-sent-events-c43ba96df7c1">Long Polling vs WebSockets vs Server-Sent Events</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huchong/p/8595644.html">轮询、长轮询、长连接、websocket</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alexandrevicenzi/go-sse">go-sse</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2017/05/server-sent_events.html">server sent event 教程</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kevinmythcheng.github.io/2022/07/10/%E7%94%A8go%E5%AE%9E%E7%8E%B0sse/" data-id="cl6rj50ci0003uzul3qh4d4qc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Go/" rel="tag">Go</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/07/10/Typora%E4%BD%BF%E7%94%A8cos/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Typora 配置图床
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/go%E7%9A%84%E5%B0%8F%E5%A4%A9%E5%9C%B0/">go的小天地</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B0%8F%E5%B7%A5%E5%85%B7/">小工具</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/" rel="tag">Go</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Go/" style="font-size: 10px;">Go</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/07/10/Typora%E4%BD%BF%E7%94%A8cos/">Typora 配置图床</a>
          </li>
        
          <li>
            <a href="/2022/07/10/%E7%94%A8go%E5%AE%9E%E7%8E%B0sse/">用go实现sse</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Kevin Chenge<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>